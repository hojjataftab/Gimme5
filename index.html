// Google Apps Script for Gimme5 Bot & WebApp
var sheetName = "Sheet1"; // نام شیت خود را اینجا چک کنید (معمولا Sheet1 است)

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(sheetName);
  var data = JSON.parse(e.postData.contents);
  
  var userId = data.uId;
  var username = data.username;
  var refBy = data.refBy;
  var date = new Date();

  // بررسی تکراری نبودن کاربر
  var dataRange = sheet.getDataRange().getValues();
  var isNewUser = true;
  for (var i = 1; i < dataRange.length; i++) {
    if (dataRange[i][1] == userId) {
      isNewUser = false;
      break;
    }
  }

  // اگر کاربر جدید بود، ذخیره کن
  if (isNewUser) {
    sheet.appendRow([date, userId, username, 0, refBy, "ACTIVE"]);
  }
  
  return ContentService.createTextOutput(JSON.stringify({"result": "success"})).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(sheetName);
  var dataRange = sheet.getDataRange().getValues();
  
  var userId = e.parameter.uId;
  var refCount = 0;

  // شمارش تعداد دعوت‌ها برای این کاربر
  for (var i = 1; i < dataRange.length; i++) {
    if (dataRange[i][4] == userId) { // ستون E (اندیس 4) مربوط به ReferrerID است
      refCount++;
    }
  }

  var result = {
    "refCount": refCount,
    "totalParticipants": dataRange.length - 1
  };

  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}
